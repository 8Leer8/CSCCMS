<div class="bg-white rounded-lg shadow-lg overflow-hidden border border-gray-100">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between p-6 border-b border-gray-200">
        <div class="mb-4 md:mb-0">
            <h2 class="text-xl font-bold text-gray-800">Event List</h2>
            <p class="text-sm text-gray-600">Manage all upcoming, active, and past events</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-3">
            <button id="showDeletedBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors flex items-center justify-center text-sm font-medium">
                <i class="fas fa-trash-alt mr-2"></i> Show Deleted
            </button>
            <div class="relative inline-block text-left">
                <button id="exportDropdownBtn" type="button" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors flex items-center justify-center text-sm font-medium" aria-haspopup="true" aria-expanded="true">
                    <i class="fas fa-file-export mr-2"></i> Export
                    <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.293l3.71-4.06a.75.75 0 111.08 1.04l-4.25 4.65a.75.75 0 01-1.08 0l-4.25-4.65a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div id="exportDropdownMenu" class="origin-top-right absolute right-0 mt-2 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 hidden z-10">
                    <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="exportDropdownBtn">
                        <a href="/cscadmin/export/?model=event&format=excel" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"><i class="fas fa-file-excel mr-2 text-green-600"></i>Export to Excel</a>
                        <a href="/cscadmin/export/?model=event&format=pdf" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem"><i class="fas fa-file-pdf mr-2 text-red-600"></i>Export to PDF</a>
                    </div>
                </div>
            </div>
            <button id="addEventBtn" class="px-4 py-2 bg-primary-dark text-white rounded-md hover:bg-primary-darker transition-colors flex items-center justify-center text-sm font-medium">
                <i class="fas fa-plus mr-2"></i> Add Event
            </button>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="p-5 border-b border-gray-200 bg-gray-50">
        <div class="grid grid-cols-1 gap-5 sm:grid-cols-4">
            <div>
                <label for="statusFilter" class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Status</label>
                <select id="statusFilter" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:border-primary-dark text-sm">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="expired">Expired</option>
                    <option value="scheduled">Scheduled</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Category</label>
                <button id="categoryFilterBtn" type="button" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 bg-white text-left text-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:border-primary-dark">
                    <i class="fas fa-filter mr-2"></i>Filter Category
                </button>
            </div>
            <div>
                <label for="eventDateFilter" class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Event Date</label>
                <input type="date" id="eventDateFilter" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:border-primary-dark text-sm">
            </div>
            <div>
                <label for="searchFilter" class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Search</label>
                <div class="relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" id="searchFilter" placeholder="Search events..." class="block w-full border border-gray-300 rounded-md py-2 pl-10 pr-3 focus:outline-none focus:ring-2 focus:ring-primary-dark focus:border-primary-dark text-sm">
                </div>
            </div>
        </div>
    </div>
    
    <!-- Category Filter Modal -->
    <div class="fixed inset-0 z-50 hidden" id="categoryFilterModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                <div class="bg-white px-6 pt-6 pb-4 sm:p-8 sm:pb-4">
                    <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4">Filter by Category</h3>
                    <div class="space-y-6 max-h-96 overflow-y-auto custom-scrollbar">
                        <div>
                            <div class="mb-2 text-xs font-semibold text-blue-700 uppercase tracking-wider">Labels</div>
                            <div id="categoryFilterLabels" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div>
                            <div class="mb-2 text-xs font-semibold text-green-700 uppercase tracking-wider">Types</div>
                            <div id="categoryFilterTypes" class="flex flex-wrap gap-3"></div>
                        </div>
                        <div>
                            <div class="mb-2 text-xs font-semibold text-purple-700 uppercase tracking-wider">Audiences</div>
                            <div id="categoryFilterAudiences" class="flex flex-wrap gap-3"></div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="applyCategoryFilterBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-dark text-base font-medium text-white hover:bg-primary-darker focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">Apply</button>
                    <button type="button" id="closeCategoryFilterModalBtn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Form Modal -->
    <div class="fixed inset-0 z-50 hidden" id="formModal">
      <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" onclick="closeModal('formModal')"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl w-full">
          <div class="bg-white px-6 pt-6 pb-4 sm:p-8 sm:pb-4">
            <h3 class="text-lg leading-6 font-bold text-gray-900 mb-4" id="modalTitle">Event Form</h3>
            <div id="modalBody" class="max-h-[70vh] overflow-y-auto"></div>
          </div>
          <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
            <button type="button" id="modalSubmitBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-dark text-base font-medium text-white hover:bg-primary-darker focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" onclick="submitEventForm()">Submit</button>
            <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeModal('formModal')">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Events Table -->
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Event Details</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date & Location</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Publish Period</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Categories</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                    <th scope="col" class="px-6 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="eventsTableBody">
                <!-- Events will be loaded here -->
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex items-center justify-between" id="paginationContainer">
        <!-- Pagination will be loaded here -->
    </div>
</div>

<!-- Deleted Events Modal -->
<div class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true" id="deletedEventsModal">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
    
    <!-- Modal panel -->
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-6xl sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Deleted Events
            </h3>
            <div class="mt-4">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                      <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                      <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200" id="deletedEventsTableBody">
                    <!-- Deleted events will be loaded here -->
                  </tbody>
                </table>
              </div>
              
              <!-- Pagination -->
              <div class="px-4 py-3 bg-gray-50 border-t border-gray-200" id="deletedEventsPagination">
                <!-- Pagination will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="closeDeletedEventsModal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Image Preview Modal -->
<div class="fixed inset-0 z-50 overflow-y-auto hidden" aria-labelledby="image-modal-title" role="dialog" aria-modal="true" id="imagePreviewModal">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" id="imageModalBackdrop"></div>
    
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="image-modal-title">Event Image Preview</h3>
            <div class="flex justify-center">
              <img id="largeEventImage" src="" alt="Event Image" class="max-h-[70vh] max-w-full object-contain">
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-dark sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" id="closeImageModal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Global variables for event management
window.showingDeletedEvents = false;
let itemIdToDelete = null;

// Utility functions
function showLoading() {
    $('.loading-spinner').addClass('show');
}

function hideLoading() {
    $('.loading-spinner').removeClass('show');
}

function showAlert(type, message) {
    const alertTypes = {
        'success': 'bg-green-100 border-green-400 text-green-700',
        'danger': 'bg-red-100 border-red-400 text-red-700',
        'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700',
        'info': 'bg-blue-100 border-blue-400 text-blue-700'
    };
    
    const alertHtml = `
        <div class="border-l-4 ${alertTypes[type]} p-4 mb-4 rounded">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    ${type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    ${type === 'danger' ? '<i class="fas fa-exclamation-circle text-red-500"></i>' : ''}
                    ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-yellow-500"></i>' : ''}
                    ${type === 'info' ? '<i class="fas fa-info-circle text-blue-500"></i>' : ''}
                </div>
                <div class="ml-3">
                    <p class="text-sm">${message}</p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" class="text-gray-500 hover:text-gray-700" onclick="$(this).parent().parent().parent().remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#messages-container').html(alertHtml);
    
    setTimeout(() => {
        $('#messages-container').empty();
    }, 5000);
}

function openModal(modalId) {
    $('#' + modalId).removeClass('hidden');
}

function closeModal(modalId) {
    $('#' + modalId).addClass('hidden');
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatTime(timeString) {
    if (!timeString) return '';
    if (/^\d{2}:\d{2}$/.test(timeString)) return timeString;
    if (/^\d{2}:\d{2}:\d{2}$/.test(timeString)) return timeString.substring(0, 5);
    
    try {
        const [hours, minutes] = timeString.split(':');
        return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
    } catch (e) {
        return timeString;
    }
}

// Event management functions
function updateSubmitButton(mode) {
    const $btn = $('#modalSubmitBtn');
    if (mode === 'edit') {
        $btn.html('<i class="fas fa-save mr-2"></i> Save Changes');
    } else {
        $btn.html('<i class="fas fa-plus-circle mr-2"></i> Add Event');
    }
}

function showEventForm(mode = 'create', eventId = null) {
    showLoading();
    currentEventId = eventId;
    updateSubmitButton(mode);
    
    $.ajax({
        url: '/cscadmin/events/event_form',
        method: 'GET',
        success: function(html) {
            $('#modalBody').html(html);
            $('#modalTitle').text(mode === 'edit' ? 'Edit Event' : 'Create New Event');
            openModal('formModal');
            if (mode === 'edit' && eventId) {
                loadEventData(eventId);
            } else {
                hideLoading();
            }
        },
        error: function(xhr, status, error) {
            hideLoading();
            showAlert('danger', 'Failed to load event form');
            console.error("Add Event AJAX error:", status, error, xhr);
        }
    });
}

function loadEventData(eventId) {
    showLoading();
    
    $.ajax({
        url: `/cscadmin/events/${eventId}/update/`,
        method: 'GET',
        success: function(response) {
            if (response.success && response.event) {
                const event = response.event;
                $('#eventId').val(event.id);
                $('#eventName').val(event.name);
                $('#eventStatus').val(event.status);
                $('#eventDate').val(event.date_event);
                $('#eventStartTime').val(event.start_at);
                $('#eventEndTime').val(event.end_at);
                $('#eventLocation').val(event.location);
                $('#eventLandmark').val(event.landmark);
                $('#eventPublishStart').val(event.start_publish_on);
                $('#eventPublishEnd').val(event.end_publish_on);
                $('#eventContext').val(event.context);
                $('#eventDescription').val(event.description);
                
                // Handle categories
                if (Array.isArray(event.labels)) {
                    event.labels.forEach(function(id) {
                        $(`input[name="eventLabels"][value="${id}"]`).prop('checked', true);
                    });
                }
                if (Array.isArray(event.types)) {
                    event.types.forEach(function(id) {
                        $(`input[name="eventTypes"][value="${id}"]`).prop('checked', true);
                    });
                }
                if (Array.isArray(event.audiences)) {
                    event.audiences.forEach(function(id) {
                        $(`input[name="eventAudiences"][value="${id}"]`).prop('checked', true);
                    });
                }
                
                // Handle image
                if (event.event_img) {
                    $('#currentImage').attr('src', event.event_img);
                    $('#currentImageContainer').removeClass('hidden');
                    $('#fileName').text('Current image');
                } else {
                    $('#currentImageContainer').addClass('hidden');
                    $('#fileName').text('No file chosen');
                }
            } else {
                showAlert('danger', 'Failed to load event data: Invalid response format');
            }
            hideLoading();
        },
        error: function(xhr, status, error) {
            hideLoading();
            showAlert('danger', 'Failed to load event data: ' + (error || 'Unknown error'));
            console.error('Error loading event data:', status, error, xhr);
        }
    });
}

function setSelectedOptions(selector, selectedValues) {
    if (selectedValues && selectedValues.length > 0) {
        $(selector).val(selectedValues);
    }
}

function submitEventForm() {
    showLoading();
    
    const form = document.getElementById('eventForm');
    const formData = new FormData(form);
    const isEdit = !!currentEventId;
    
    $.ajax({
        url: isEdit ? `/cscadmin/events/${currentEventId}/update/` : '/cscadmin/events/create/',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', isEdit ? 'Event updated successfully!' : 'Event created successfully!');
                closeModal('formModal');
                loadEvents();
            } else {
                showAlert('danger', response.error || 'Operation failed');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to save event';
            showAlert('danger', error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

function deleteEvent() {
    showLoading();
    
    $.ajax({
        url: `/cscadmin/events/${itemIdToDelete}/delete/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Event deleted successfully');
                closeModal('deleteModal');
                loadEvents();
            } else {
                showAlert('danger', response.error || 'Failed to delete event');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to delete event';
            showAlert('danger', error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Event list rendering and management
function renderEventsTable(data) {
    console.log(event.labels, event.types, event.audiences);
    console.log("Rendering events table with data:", data);
    let tableRows = '';
    
    if (data.events && data.events.length > 0) {
        console.log("Number of events to render:", data.events.length);
        data.events.forEach(event => {
            console.log("Processing event:", event);
            const statusBadgeClass = {
                'active': 'bg-green-100 text-green-800',
                'expired': 'bg-red-100 text-red-800',
                'scheduled': 'bg-blue-100 text-blue-800'
            }[event.status] || 'bg-gray-100 text-gray-800';
            
            const eventDate = event.date_event ? new Date(event.date_event).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const publishStart = event.start_publish_on ? new Date(event.start_publish_on).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const publishEnd = event.end_publish_on ? new Date(event.end_publish_on).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const eventImage = event.event_img ? 
                `<img src="${event.event_img}" alt="${event.name}" class="h-12 w-12 rounded-md object-cover cursor-pointer hover:opacity-75 event-image-preview" data-src="${event.event_img}">` :
                `<div class="h-12 w-12 rounded-md bg-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-calendar-alt"></i></div>`;
            
            const context = event.context ? 
                (event.context.length > 100 ? event.context.substring(0, 97) + '...' : event.context) :
                'No description available';
            
            // Clean grouped categories
            let categoriesHtml = '';
            const labelNames = (event.labels || []).map(cat => typeof cat === 'string' ? cat : (cat.type || cat.name || '')).filter(Boolean);
            const typeNames = (event.types || []).map(cat => typeof cat === 'string' ? cat : (cat.type || cat.name || '')).filter(Boolean);
            const audienceNames = (event.audiences || []).map(cat => typeof cat === 'string' ? cat : (cat.type || cat.name || '')).filter(Boolean);
            if (labelNames.length || typeNames.length || audienceNames.length) {
                if (labelNames.length) {
                    categoriesHtml += `<div class='inline-block mb-1 px-2 py-1 rounded bg-blue-100 text-blue-800 text-xs font-medium'><strong>Label:</strong> ${labelNames.join(', ')}</div><br/>`;
                }
                if (typeNames.length) {
                    categoriesHtml += `<div class='inline-block mb-1 px-2 py-1 rounded bg-green-100 text-green-800 text-xs font-medium'><strong>Type:</strong> ${typeNames.join(', ')}</div><br/>`;
                }
                if (audienceNames.length) {
                    categoriesHtml += `<div class='inline-block mb-1 px-2 py-1 rounded bg-purple-100 text-purple-800 text-xs font-medium'><strong>Audience:</strong> ${audienceNames.join(', ')}</div>`;
                }
            } else {
                categoriesHtml = '<span class="text-gray-400 text-sm">No categories</span>';
            }

            // Minimalist publish period
            let publishPeriodHtml = 'Not specified';
            if (publishStart && publishEnd) {
                publishPeriodHtml = `${publishStart} → ${publishEnd}`;
            } else if (publishStart) {
                publishPeriodHtml = `${publishStart}`;
            } else if (publishEnd) {
                publishPeriodHtml = `${publishEnd}`;
            }

            tableRows += `
                <tr class="${event.is_deleted ? 'bg-gray-50' : 'hover:bg-gray-50'}">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">${eventImage}</div>
                            <div class="ml-4">
                                <div class="text-sm font-medium ${event.is_deleted ? 'text-gray-500' : 'text-gray-900'}">${event.name || 'Untitled Event'}</div>
                                <div class="text-sm ${event.is_deleted ? 'text-gray-400' : 'text-gray-500'} max-w-xl">${context}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm ${event.is_deleted ? 'text-gray-500' : 'text-gray-900'}">${eventDate}</div>
                        <div class="text-sm ${event.is_deleted ? 'text-gray-400' : 'text-gray-500'}">${event.location || 'Not specified'}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-xs">${publishPeriodHtml}</span>
                    </td>
                    <td class="px-6 py-4">
                        ${categoriesHtml}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadgeClass}">
                            ${(event.status || 'unknown').charAt(0).toUpperCase() + (event.status || 'unknown').slice(1)}
                            ${event.is_deleted ? ' (Deleted)' : ''}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium">
                        ${event.is_deleted ? `
                            <button class="text-green-600 hover:text-green-900 restore-event-btn mr-3" data-id="${event.id}">
                                <i class="fas fa-trash-restore"></i>
                            </button>
                        ` : `
                            <button class="text-blue-600 hover:text-blue-900 edit-event-btn mr-3" data-id="${event.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-900 delete-event-btn" data-id="${event.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `}
                    </td>
                </tr>
            `;
        });
    } else {
        console.log("No events to render");
        tableRows = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="text-sm">No events found</p>
                    </div>
                </td>
            </tr>
        `;
    }
    
    console.log("Generated table HTML:", tableRows);
    $('#eventsTableBody').html(tableRows);
    console.log("Table body after update:", $('#eventsTableBody').html());
    renderPagination(data);
    
    // Attach event handlers
    $('.edit-event-btn').click(function() {
        const eventId = $(this).data('id');
        showEventForm('edit', eventId);
    });
    
    $('.delete-event-btn').click(function() {
        const eventId = $(this).data('id');
        showDeleteConfirmation(eventId);
    });
    
    $('.restore-event-btn').click(function() {
        const eventId = $(this).data('id');
        restoreEvent(eventId);
    });
    
    $('.event-image-preview').click(function() {
        const imageSrc = $(this).data('src');
        showImagePreview(imageSrc);
    });
}

function renderPagination(data) {
    let paginationHtml = '';
    
    if (data.total_pages > 1) {
        paginationHtml += `<div class="flex items-center justify-between">`;
        paginationHtml += `<div class="flex-1 flex justify-between sm:hidden">`;
        
        if (data.has_previous) {
            paginationHtml += `<a href="#" data-page="${data.previous_page_number}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>`;
        } else {
            paginationHtml += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Previous</span>`;
        }
        
        if (data.has_next) {
            paginationHtml += `<a href="#" data-page="${data.next_page_number}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>`;
        } else {
            paginationHtml += `<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Next</span>`;
        }
        
        paginationHtml += `</div>`;
        paginationHtml += `<div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">`;
        paginationHtml += `<div class="text-sm text-gray-700">
            Showing <span class="font-medium">${data.start_index}</span> to <span class="font-medium">${data.end_index}</span> of <span class="font-medium">${data.total_items}</span> results
        </div>`;
        
        paginationHtml += `<div><ul class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">`;
        
        if (data.has_previous) {
            paginationHtml += `
                <li>
                    <a href="#" data-page="${data.previous_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
        }
        
        for (let i = 1; i <= data.total_pages; i++) {
            if (i === data.current_page) {
                paginationHtml += `
                    <li>
                        <a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            ${i}
                        </a>
                    </li>
                `;
            } else if (i > data.current_page - 3 && i < data.current_page + 3) {
                paginationHtml += `
                    <li>
                        <a href="#" data-page="${i}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            ${i}
                        </a>
                    </li>
                `;
            }
        }
        
        if (data.has_next) {
            paginationHtml += `
                <li>
                    <a href="#" data-page="${data.next_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
        }
        
        paginationHtml += `</ul></div></div></div>`;
    }
    
    $('#paginationContainer').html(paginationHtml);
    // Attach click handlers to pagination links using event delegation
    $('#paginationContainer').off('click', 'a[data-page]').on('click', 'a[data-page]', function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        loadEvents(page);
    });
}

function loadEvents(page = 1) {
    showLoading();
    const params = {
        status: $('#statusFilter').val(),
        event_date: $('#eventDateFilter').val(),
        search: $('#searchFilter').val(),
        page: page,
        show_deleted: window.showingDeletedEvents
    };

    // Add selected categories to params
    const selectedLabels = [];
    const selectedTypes = [];
    const selectedAudiences = [];

    $('#categoryFilterLabels input:checked').each(function() {
        selectedLabels.push($(this).val());
    });
    $('#categoryFilterTypes input:checked').each(function() {
        selectedTypes.push($(this).val());
    });
    $('#categoryFilterAudiences input:checked').each(function() {
        selectedAudiences.push($(this).val());
    });

    if (selectedLabels.length) {
        params.labels = selectedLabels.join(',');
    } else {
        delete params.labels;
    }
    if (selectedTypes.length) {
        params.types = selectedTypes.join(',');
    } else {
        delete params.types;
    }
    if (selectedAudiences.length) {
        params.audiences = selectedAudiences.join(',');
    } else {
        delete params.audiences;
    }

    $.ajax({
        url: '/cscadmin/events/list/',
        method: 'GET',
        data: params,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log("Events loaded (success handler):", response);
            try {
                renderEventsTable(response);
            } catch (e) {
                console.error('Error in renderEventsTable:', e, response);
            }
        },
        error: function(xhr, status, error) {
            console.error('AJAX error in loadEvents:', status, error, xhr);
            showAlert('danger', 'Failed to load events');
        },
        complete: function(xhr, status) {
            console.log('AJAX complete in loadEvents:', status);
            hideLoading();
        }
    });
}

// Deleted events management
function loadDeletedEvents(page = 1) {
    showLoading();
    $.ajax({
        url: '/cscadmin/events/list/',
        method: 'GET',
        data: {
            show_deleted: true,
            page: page
        },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            console.log("Deleted events loaded:", response);
            if (response.events && response.events.length > 0) {
                renderDeletedEventsTable(response);
            } else {
                $('#deletedEventsTableBody').html(`
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center">
                            <div class="text-gray-400">
                                <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                <p class="text-sm">No deleted events found</p>
                            </div>
                        </td>
                    </tr>
                `);
                $('#deletedEventsPagination').empty();
            }
        },
        error: function(xhr) {
            console.error('Error loading deleted events:', xhr);
            showAlert('danger', 'Failed to load deleted events');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function renderDeletedEventsTable(data) {
    let tableRows = '';
    
    if (data.events && data.events.length > 0) {
        data.events.forEach(event => {
            const eventDate = event.date_event ? new Date(event.date_event).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            let timeDisplay = '';
            if (event.start_at || event.end_at) {
                const startTime = event.start_at ? formatTime(event.start_at) : '';
                const endTime = event.end_at ? formatTime(event.end_at) : '';
                timeDisplay = startTime && endTime ? `${startTime} - ${endTime}` : startTime || endTime || 'Time not specified';
            }
            
            const eventImage = event.event_img ? 
                `<img src="${event.event_img}" alt="${event.name}" class="h-10 w-10 rounded-md object-cover cursor-pointer hover:opacity-75 event-image-preview" data-src="${event.event_img}">` :
                `<div class="h-10 w-10 rounded-md bg-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-calendar-alt"></i></div>`;
            
            tableRows += `
                <tr class="bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">${eventImage}</div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${event.name || 'Untitled Event'}</div>
                                <div class="text-sm text-gray-500 max-w-xl">
                                    ${event.description ? (event.description.length > 100 ? event.description.substring(0, 97) + '...' : event.description) : 'No description'}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${eventDate}</div>
                        <div class="text-sm text-gray-500">${timeDisplay}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-200 text-gray-800">
                            Deleted
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium">
                        <button class="text-green-600 hover:text-green-900 restore-event-btn mr-3" data-id="${event.id}">
                            <i class="fas fa-trash-restore"></i> Restore
                        </button>
                    </td>
                </tr>
            `;
        });
    } else {
        tableRows = `
            <tr>
                <td colspan="4" class="px-6 py-8 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="text-sm">No deleted events found</p>
                    </div>
                </td>
            </tr>
        `;
    }
    
    $('#deletedEventsTableBody').html(tableRows);
    renderDeletedEventsPagination(data);
    
    // Attach event handlers
    $('.restore-event-btn').click(function() {
        const eventId = $(this).data('id');
        restoreEvent(eventId);
    });
    
    $('.permanent-delete-event-btn').click(function() {
        const eventId = $(this).data('id');
        if (confirm('Are you sure you want to permanently delete this event? This action cannot be undone.')) {
            permanentDeleteEvent(eventId);
        }
    });
    
    $('.event-image-preview').click(function() {
        const imgSrc = $(this).data('src');
        $('#largeEventImage').attr('src', imgSrc);
        $('#imagePreviewModal').removeClass('hidden');
    });
}

function renderDeletedEventsPagination(data) {
    let paginationHtml = '';
    
    if (data.total_pages > 1) {
        paginationHtml += `<div class="flex items-center justify-between">`;
        paginationHtml += `<div class="flex-1 flex justify-between sm:hidden">`;
        
        if (data.has_previous) {
            paginationHtml += `<a href="#" data-page="${data.previous_page_number}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</a>`;
        } else {
            paginationHtml += `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Previous</span>`;
        }
        
        if (data.has_next) {
            paginationHtml += `<a href="#" data-page="${data.next_page_number}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</a>`;
        } else {
            paginationHtml += `<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">Next</span>`;
        }
        
        paginationHtml += `</div>`;
        paginationHtml += `<div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">`;
        paginationHtml += `<div class="text-sm text-gray-700">
            Showing <span class="font-medium">${data.start_index}</span> to <span class="font-medium">${data.end_index}</span> of <span class="font-medium">${data.total_items}</span> results
        </div>`;
        
        paginationHtml += `<div><ul class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">`;
        
        if (data.has_previous) {
            paginationHtml += `
                <li>
                    <a href="#" data-page="${data.previous_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Previous</span>
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
        }
        
        for (let i = 1; i <= data.total_pages; i++) {
            if (i === data.current_page) {
                paginationHtml += `
                    <li>
                        <a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            ${i}
                        </a>
                    </li>
                `;
            } else if (i > data.current_page - 3 && i < data.current_page + 3) {
                paginationHtml += `
                    <li>
                        <a href="#" data-page="${i}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                            ${i}
                        </a>
                    </li>
                `;
            }
        }
        
        if (data.has_next) {
            paginationHtml += `
                <li>
                    <a href="#" data-page="${data.next_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Next</span>
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
        }
        
        paginationHtml += `</ul></div></div></div>`;
    }
    
    $('#deletedEventsPagination').html(paginationHtml);
    
    // Attach click handlers to pagination links
    $('#deletedEventsPagination a[data-page]').click(function(e) {
        e.preventDefault();
        const page = $(this).data('page');
        loadDeletedEvents(page);
    });
}

function restoreEvent(eventId) {
    showLoading();
    $.ajax({
        url: `/events/${eventId}/restore/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Event restored successfully');
                loadDeletedEvents();
                loadEvents();
            } else {
                showAlert('danger', response.error || 'Failed to restore event');
            }
        },
        error: function(xhr) {
            showAlert('danger', 'Failed to restore event');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function permanentDeleteEvent(eventId) {
    showLoading();
    
    $.ajax({
        url: `/cscadmin/events/${eventId}/permanent-delete/`,
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Event permanently deleted');
                loadDeletedEvents();
            } else {
                showAlert('danger', response.error || 'Failed to delete event');
            }
        },
        error: function(xhr) {
            showAlert('danger', 'Failed to delete event');
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Initialize the page
$(document).ready(function() {
    // Add new event button
    $('#addEventBtn').click(function() {
        showEventForm('create');
    });
    
    // Show deleted events modal
    $('#showDeletedBtn').click(function() {
        $('#deletedEventsModal').removeClass('hidden');
        loadDeletedEvents();
    });
    
    // Close deleted events modal
    $('#closeDeletedEventsModal').click(function() {
        $('#deletedEventsModal').addClass('hidden');
    });
    
    // Close image preview modal
    $('#closeImageModal, #imageModalBackdrop').click(function() {
        $('#imagePreviewModal').addClass('hidden');
    });
    
    // Confirm delete button
    $('#confirmDelete').click(function() {
        deleteEvent();
    });
    
    // Filter change handlers
    $('#statusFilter, #eventDateFilter').change(function() {
        loadEvents();
    });

    $('#searchFilter').on('keyup', function(e) {
        if (e.key === 'Enter') {
            loadEvents();
        }
    });

    // Category filter modal handlers
    $('#categoryFilterBtn').click(function() {
        openModal('categoryFilterModal');
    });

    $('#closeCategoryFilterModalBtn').click(function() {
        closeModal('categoryFilterModal');
    });

    $('#applyCategoryFilterBtn').click(function() {
        closeModal('categoryFilterModal');
        loadEvents();
    });

    // Load initial events
    loadEvents();

    // Style checkboxes in modal
    setTimeout(function() {
        $('#categoryFilterModal input[type="checkbox"]').addClass('form-checkbox h-4 w-4 text-primary-dark rounded border-gray-300 focus:ring-primary-dark');
    }, 100);
});
</script>

<style>
.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
}
.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #c5c5c5;
    border-radius: 4px;
}
.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>