<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <!-- Tailwind CSS -->
     {% load static %}
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            light: '#f0fdf4',
                            DEFAULT: '#166534',
                            dark: '#14532d',
                        },
                        secondary: {
                            light: '#fee2e2',
                            DEFAULT: '#b91c1c',
                            dark: '#991b1b',
                        },
                        neutral: {
                            light: '#f5f5f5',
                            DEFAULT: '#404040',
                            dark: '#262626',
                        }
                    }
                }
            }
        }
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        .loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .loading-spinner.show {
            display: flex;
        }
        .loading-spinner .spinner {
            animation: spin 1s linear infinite;
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-link {
            color: #404040;
        }
        .nav-link:hover {
            background-color: #14532d;
            color: #f5f5f5;
        }
        .nav-link.active {
            background-color: #166534;
            color: #f5f5f5;
        }
        body {
            background-color: #f0fdf4;
        }
        .bg-primary-light {
            background-color: #f0fdf4;
        }
        .text-primary-dark {
            color: #14532d;
        }
        .bg-neutral-light {
            background-color: #f5f5f5;
        }
        .dropdown-arrow {
            transition: transform 0.2s ease-in-out;
        }
        .dropdown-arrow.rotate-180 {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="font-sans antialiased">
    <!-- Loading Spinner -->
    <div class="loading-spinner" name="base">
        <div class="spinner"></div>
    </div>

    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="hidden md:flex md:flex-shrink-0">
            <div class="flex flex-col w-64 bg-neutral-light">
                <div class="flex items-center justify-center h-16 px-4 bg-neutral-light">
                    <span class="text-primary-dark font-semibold text-lg">College Student Council</span>
                </div>
                <div class="flex flex-col flex-grow px-4 py-4 overflow-y-auto">
                    <nav class="flex-1 space-y-2">
                        <!-- Dashboard -->
                        <a href="#" data-page="dashboard" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                            <i class="fas fa-tachometer-alt mr-3 group-hover:text-neutral-light"></i>
                            Dashboard
                        </a>
                        
                        <!-- Content Management Section -->
                        <div class="mt-4">
                            <p class="px-4 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Content Management</p>
                            <div class="mt-2 space-y-1">
                                <a href="#" data-page="accomplishments" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-check-circle mr-3 group-hover:text-neutral-light"></i>
                                    Accomplishments
                                </a>
                                <a href="#" data-page="achievements" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-trophy mr-3 group-hover:text-neutral-light"></i>
                                    Achievements
                                </a>
                                <a href="#" data-page="announcements" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-bullhorn mr-3 group-hover:text-neutral-light"></i>
                                    Announcements
                                </a>
                                <a href="#" data-page="events" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-calendar-alt mr-3 group-hover:text-neutral-light"></i>
                                    Events
                                </a>
                                <a href="#" data-page="posts" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-newspaper mr-3 group-hover:text-neutral-light"></i>
                                    Posts
                                </a>
                                <a href="#" data-page="transparency" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-file-alt mr-3 group-hover:text-neutral-light"></i>
                                    Transparency
                                </a>
                            </div>
                        </div>
                        
                        <!-- User Management Dropdown -->
                        <div class="mt-4">
                            <button onclick="toggleDropdown('user-management-dropdown')" class="flex items-center justify-between w-full px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-user-shield mr-3"></i>
                                    <span>User Management</span>
                                </div>
                                <i class="fas fa-chevron-down text-xs dropdown-arrow"></i>
                            </button>
                            <div id="user-management-dropdown" class="mt-1 pl-8 space-y-1 hidden">
                                <a href="#" data-page="accounts" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-user-cog mr-3 group-hover:text-neutral-light"></i>
                                    Accounts
                                </a>
                                <a href="#" data-page="complaints" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-exclamation-triangle mr-3 group-hover:text-neutral-light"></i>
                                    Complaints
                                </a>
                                <a href="#" data-page="feedback" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-comment-medical mr-3 group-hover:text-neutral-light"></i>
                                    Feedback
                                </a>
                                <a href="#" data-page="volunteers" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-hands-helping mr-3 group-hover:text-neutral-light"></i>
                                    Volunteers
                                </a>
                            </div>
                        </div>
                        
                        <!-- Others Dropdown (includes Categories, Officers, Committee) -->
                        <div class="mt-4">
                            <button onclick="toggleDropdown('others-dropdown')" class="flex items-center justify-between w-full px-4 py-2 text-sm font-medium text-gray-700 rounded-md hover:bg-gray-100 focus:outline-none">
                                <div class="flex items-center">
                                    <i class="fas fa-ellipsis-h mr-3"></i>
                                    <span>Others</span>
                                </div>
                                <i class="fas fa-chevron-down text-xs dropdown-arrow"></i>
                            </button>
                            <div id="others-dropdown" class="mt-1 pl-8 space-y-1 hidden">
                                <a href="#" data-page="categories" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-tags mr-3 group-hover:text-neutral-light"></i>
                                    Categories
                                </a>
                                <a href="#" data-page="officers" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-user-tie mr-3 group-hover:text-neutral-light"></i>
                                    Officers
                                </a>
                                <a href="#" data-page="committee" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                                    <i class="fas fa-users-between-lines mr-3 group-hover:text-neutral-light"></i>
                                    Committee
                                </a>
                            </div>
                        </div>
                    </nav>
                    
                    <!-- Bottom Section -->
                    <div class="mt-auto space-y-2">
                        <a href="#" data-page="settings" class="flex items-center px-4 py-2 text-sm font-medium rounded-md group nav-link">
                            <i class="fas fa-cog mr-3 group-hover:text-neutral-light"></i>
                            Settings
                        </a>
                        <a href="{% url 'logout' %}" class="flex items-center px-4 py-2 text-sm font-medium text-secondary-dark hover:text-neutral-light hover:bg-primary-dark rounded-md group">
                            <i class="fas fa-sign-out-alt mr-3 text-secondary-dark group-hover:text-neutral-light"></i>
                            Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex flex-col flex-1 overflow-hidden">
            <!-- Top Navigation -->
            <div class="flex items-center justify-between h-16 px-6 bg-neutral-light border-b border-gray-200 shadow">
                <div class="flex items-center">
                    <button class="text-gray-500 md:hidden" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="ml-4 text-xl font-semibold text-primary-dark" id="page-title">Dashboard Overview</h1>
                </div>
                
            </div>

            <!-- Mobile Sidebar -->
            <div id="mobile-sidebar" class="hidden fixed inset-0 z-40 md:hidden">
                <div class="fixed inset-0 bg-gray-600 bg-opacity-75" onclick="toggleSidebar()"></div>
                <div class="relative flex flex-col w-full max-w-xs bg-gray-800">
                    <div class="flex items-center justify-center h-16 px-4 bg-gray-900">
                        <span class="text-white font-semibold text-lg">Admin Panel</span>
                        <button class="ml-auto text-gray-400 hover:text-white" onclick="toggleSidebar()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="flex flex-col flex-grow px-4 py-4 overflow-y-auto">
                        <nav class="flex-1 space-y-2">
                            <a href="#" data-page="dashboard" class="flex items-center px-4 py-2 text-sm font-medium text-white bg-gray-700 rounded-md group nav-link">
                                <i class="fas fa-tachometer-alt mr-3 text-gray-300 group-hover:text-white"></i>
                                Dashboard
                            </a>
                            <!-- Other mobile nav links -->
                        </nav>
                        <div class="mt-auto">
                            <a href="{% url 'logout' %}" class="flex items-center px-4 py-2 text-sm font-medium text-red-400 hover:text-white hover:bg-gray-700 rounded-md group">
                                <i class="fas fa-sign-out-alt mr-3 text-red-400 group-hover:text-white"></i>
                                Logout
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messages-container" class="px-6 pt-4"></div>

            <!-- Content Container -->
            <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
                <div id="content-container">
                    <!-- Content loaded via AJAX -->
                </div>
            </main>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="fixed inset-0 z-50 hidden" id="categoryModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle">Add New Item</h3>
                            <div class="mt-4">
                                <input type="hidden" id="categoryId">
                                <input type="hidden" id="categoryType">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Name</label>
                                    <input type="text" id="categoryName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-dark focus:border-primary-dark sm:text-sm">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium text-gray-700">Description</label>
                                    <textarea id="categoryDescription" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-dark focus:border-primary-dark sm:text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Status</label>
                                    <select id="categoryStatus" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-dark focus:border-primary-dark sm:text-sm rounded-md">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="saveCategory()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-dark text-base font-medium text-white hover:bg-primary-darker focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Save
                    </button>
                    <button type="button" onclick="closeModal('categoryModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div class="fixed inset-0 z-50 hidden" id="eventModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white px-6 pt-6 pb-6 sm:p-8">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="eventModalTitle">Add New Event</h3>
                            <div class="mt-4 max-h-[70vh] overflow-y-auto custom-scrollbar" id="eventModalBody">
                                <!-- Event form will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-6 py-4 sm:px-8 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="submitEventForm()" class="w-full inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm" id="eventModalSubmitBtn">
                        <i class="fas fa-plus-circle mr-2" id="eventSubmitBtnIcon"></i>
                        <span id="eventSubmitBtnText">Add Event</span>
                    </button>
                    <button type="button" onclick="closeModal('eventModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="fixed inset-0 z-50 hidden" id="deleteModal">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Confirm Delete</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500">Are you sure you want to delete this item? This action cannot be undone.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" onclick="confirmDelete()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                        Delete
                    </button>
                    <button type="button" onclick="closeModal('deleteModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Account Modal -->
<div class="fixed inset-0 z-50 hidden" id="accountModal">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-6 pt-6 pb-6 sm:p-8">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="accountModalTitle">Add New Account</h3>
                        <div class="mt-4" id="accountModalBody">
                            <!-- Account form will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 sm:px-8 sm:flex sm:flex-row-reverse">
                <button type="button" onclick="submitAccountForm()" class="w-full inline-flex items-center justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-plus-circle mr-2" id="accountSubmitBtnIcon"></i>
                    <span id="accountSubmitBtnText">Add Account</span>
                </button>
                <button type="button" onclick="closeModal('accountModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script src="{% static 'javascript/base/admin_achievements.js' %}"></script>
    <script src="{% static 'javascript/base/admin_accomplishments.js' %}"></script>
    <script src="{% static 'javascript/base/admin_transparency.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="{% static 'javascript/admin/event_form.js' %}"></script>
    <script src="{% static 'javascript/admin/event_admin.js' %}"></script>
    <script src="{% static 'admin/account_admin.js' %}"></script>
    <script>
    // Global variables
let currentPage = sessionStorage.getItem('currentPage') || 'dashboard';
let currentCategoryType = '';
let currentCategoryId = '';
window.currentEventId = null;
let itemToDelete = { type: '', id: '' };
let showingDeletedAnnouncements = false;
let currentAnnouncementId = null;
window.showingDeletedEvents = false;

// --- Category Filter Modal Logic ---
let selectedLabelIds = [];
let selectedTypeIds = [];
let selectedAudienceIds = [];

$(document).on('click', '#categoryFilterBtn', function() {
    // Open modal
    $('#categoryFilterModal').removeClass('hidden');
    // Fetch and populate options
    $.get('/cscadmin/events/form-data/', function(response) {
        // Labels
        let labelHtml = '';
        (response.event_labels || []).forEach(label => {
            const checked = selectedLabelIds.includes(label.id) ? 'checked' : '';
            labelHtml += `<label class='inline-flex items-center'><input type='checkbox' class='category-label-checkbox' value='${label.id}' ${checked}> <span class='ml-1'>${label.type}</span></label>`;
        });
        $('#categoryFilterLabels').html(labelHtml || '<span class="text-gray-400 text-xs">No labels</span>');
        // Types
        let typeHtml = '';
        (response.event_types || []).forEach(type => {
            const checked = selectedTypeIds.includes(type.id) ? 'checked' : '';
            typeHtml += `<label class='inline-flex items-center'><input type='checkbox' class='category-type-checkbox' value='${type.id}' ${checked}> <span class='ml-1'>${type.type}</span></label>`;
        });
        $('#categoryFilterTypes').html(typeHtml || '<span class="text-gray-400 text-xs">No types</span>');
        // Audiences
        let audienceHtml = '';
        (response.audiences || []).forEach(aud => {
            const checked = selectedAudienceIds.includes(aud.id) ? 'checked' : '';
            audienceHtml += `<label class='inline-flex items-center'><input type='checkbox' class='category-audience-checkbox' value='${aud.id}' ${checked}> <span class='ml-1'>${aud.type}</span></label>`;
        });
        $('#categoryFilterAudiences').html(audienceHtml || '<span class="text-gray-400 text-xs">No audiences</span>');
    });
});

$(document).on('click', '#closeCategoryFilterModalBtn', function() {
    $('#categoryFilterModal').addClass('hidden');
});

$(document).on('click', '#applyCategoryFilterBtn', function() {
    // Collect selected IDs
    selectedLabelIds = [];
    selectedTypeIds = [];
    selectedAudienceIds = [];
    $('#categoryFilterLabels input:checked').each(function() { selectedLabelIds.push(parseInt($(this).val())); });
    $('#categoryFilterTypes input:checked').each(function() { selectedTypeIds.push(parseInt($(this).val())); });
    $('#categoryFilterAudiences input:checked').each(function() { selectedAudienceIds.push(parseInt($(this).val())); });
    $('#categoryFilterModal').addClass('hidden');
    loadEvents();
});

// --- Update loadEvents to include category filters ---
function loadEvents(page = 1) {
    showLoading();
    const params = {
        status: $('#statusFilter').val(),
        date_from: $('#dateFromFilter').val(),
        date_to: $('#dateToFilter').val(),
        search: $('#searchFilter').val(),
        page: page
    };
    if (selectedLabelIds.length > 0) params.labels = selectedLabelIds.join(',');
    if (selectedTypeIds.length > 0) params.types = selectedTypeIds.join(',');
    if (selectedAudienceIds.length > 0) params.audiences = selectedAudienceIds.join(',');
    $.ajax({
        url: '/cscadmin/events/list/',
        method: 'GET',
        data: params,
        success: function(response) {
            renderEventsTable(response);
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to load events';
            showAlert('danger', error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Utility functions
function toggleSidebar() {
    $('#mobile-sidebar').toggleClass('hidden');
}

function toggleDropdown(dropdownId) {
    const dropdown = $('#' + dropdownId);
    dropdown.toggleClass('hidden');
    // Rotate the arrow icon
    dropdown.prev().find('.dropdown-arrow').toggleClass('rotate-180');
}

function openModal(modalId) {
    $('#' + modalId).removeClass('hidden');
}

function closeModal(modalId) {
    $('#' + modalId).addClass('hidden');
}

function showLoading() {
    $('.loading-spinner').addClass('show').removeClass('hidden');
}

function hideLoading() {
    $('.loading-spinner').removeClass('show').addClass('hidden');
}

function showAlert(type, message) {
    const alertTypes = {
        'success': 'bg-green-100 border-green-400 text-green-700',
        'danger': 'bg-red-100 border-red-400 text-red-700',
        'warning': 'bg-yellow-100 border-yellow-400 text-yellow-700',
        'info': 'bg-blue-100 border-blue-400 text-blue-700'
    };
    
    const alertHtml = `
        <div class="border-l-4 ${alertTypes[type]} p-4 mb-4 rounded">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    ${type === 'success' ? '<i class="fas fa-check-circle text-green-500"></i>' : ''}
                    ${type === 'danger' ? '<i class="fas fa-exclamation-circle text-red-500"></i>' : ''}
                    ${type === 'warning' ? '<i class="fas fa-exclamation-triangle text-yellow-500"></i>' : ''}
                    ${type === 'info' ? '<i class="fas fa-info-circle text-blue-500"></i>' : ''}
                </div>
                <div class="ml-3">
                    <p class="text-sm">${message}</p>
                </div>
                <div class="ml-auto pl-3">
                    <button type="button" class="text-gray-500 hover:text-gray-700" onclick="$(this).parent().parent().parent().remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    $('#messages-container').html(alertHtml);
    
    setTimeout(() => {
        $('#messages-container').empty();
    }, 5000);
}

function escapeHtml(text) {
    if (!text) return '';
    return text.toString()
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Load page content
function loadPageContent(page) {
    showLoading();
    currentPage = page;
    sessionStorage.setItem('currentPage', page);

    // Update active nav link
    $('.nav-link').removeClass('bg-primary-dark text-neutral-light').addClass('text-black hover:bg-primary-dark hover:text-neutral-light');
    $(`.nav-link[data-page="${page}"]`).removeClass('text-black hover:bg-primary-dark hover:text-neutral-light').addClass('bg-primary-dark text-neutral-light');  
    
    // Update page title
    const pageTitles = {
        'dashboard': 'Dashboard Overview',
        'posts': 'Post Management',
        'events': 'Event Management',
        'announcements': 'Announcement Management',
        'complaints': 'Complaint Management',
        'achievements': 'Achievement Management',
        'accomplishments': 'Accomplishment Management',
        'volunteers': 'Volunteer Management',
        'accounts': 'Account Management',
        'transparency': 'Transparency Management',
        'feedback': 'Feedback Management',
        'settings': 'System Settings',
        'categories': 'Categories Management',
        'officers': 'Officers Management',
        'committee': 'Committee Management'
    };
    $('#page-title').text(pageTitles[page] || 'Admin Panel');

    // Load content
    $.ajax({
        url: '/cscadmin/',
        method: 'GET',
        data: { page: page },
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.html) {
                $('#content-container').html(response.html);
                
                if (page === 'dashboard') {
                    initializeDashboard(response.data || {});
                } else if (page === 'events') {
                    initializeEventList();
                    loadEvents();
                } else if (page === 'announcements') {
                    initializeAnnouncementList();
                } else if (page === 'categories') {
                    initializeCategoriesPage();
                } else if (page === 'officers') {
                    initializeOfficersPage();
                } else if (page === 'committee') {
                    initializeCommitteePage();
                } else if (page === 'achievements') {
                    initializeAchievementList();
                } else if (page === 'accomplishments') {
                    initializeAccomplishmentList();
                } else if (page === 'volunteers') {
                    initializeVolunteersPage();
                } else if (page === 'accounts') {
                    initializeAccountList();
                } else if (page === 'feedback') {
                    initializeFeedbackPage();
                } else if (page === 'settings') {
                    initializeSettingsPage();
                } else if (page === 'transparency') {
                    initializeTransparencyList();
                }
            } else {
                showAlert('danger', 'Invalid response format');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading page:', error);
            showAlert('danger', 'Failed to load page content.');
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Dashboard functions
function initializeDashboard(data) {
    // Update dashboard cards
    if (data.total_posts !== undefined) $('#totalPosts').text(data.total_posts);
    if (data.total_events !== undefined) $('#totalEvents').text(data.total_events);
    if (data.total_announcements !== undefined) $('#totalAnnouncements').text(data.total_announcements);
    if (data.pending_complaints !== undefined) $('#pendingComplaints').text(data.pending_complaints);
    if (data.total_achievements !== undefined) $('#totalAchievements').text(data.total_achievements);
    if (data.total_volunteers !== undefined) $('#totalVolunteers').text(data.total_volunteers);

    // Initialize charts if data exists
    if (data.posts_by_category) {
        initializeChart('postsByCategoryChart', 'bar', 
                       data.posts_by_category.map(item => item.category__category || 'Unknown'),
                       data.posts_by_category.map(item => item.count || 0),
                       'Posts by Category');
    }
    
    if (data.events_by_status) {
        initializeChart('eventsStatusChart', 'doughnut',
                       data.events_by_status.map(item => item.status || 'Unknown'),
                       data.events_by_status.map(item => item.count || 0),
                       'Events by Status');
    }
    
    if (data.complaints_by_status) {
        initializeChart('complaintsStatusChart', 'pie',
                       data.complaints_by_status.map(item => item.remarks || 'Unknown'),
                       data.complaints_by_status.map(item => item.count || 0),
                       'Complaints by Status');
    }
}

function initializeChart(chartId, type, labels, data, label) {
    const ctx = document.getElementById(chartId).getContext('2d');
    new Chart(ctx, {
        type: type,
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: data,
                backgroundColor: getChartColors(type, data.length),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                }
            }
        }
    });
}

function getChartColors(type, count) {
    if (type === 'pie' || type === 'doughnut') {
        return ['#4BC0C0', '#FF9F40', '#9966FF', '#FFCD56', '#36A2EB', '#FF6384'].slice(0, count);
    }
    return ['rgba(54, 162, 235, 0.5)'];
}

// Event management functions
function initializeEventList() {
    // Set up event handlers
    $(document).on('click', '#addEventBtn', showEventForm);
    $(document).on('click', '.edit-event-btn', function() {
        const eventId = $(this).data('id');
        showEventForm('edit', eventId);
    });
    $(document).on('click', '.delete-event-btn', function() {
        itemToDelete = { type: 'event', id: $(this).data('id') };
        openModal('deleteModal');
    });

    // Filter handling
    $('#statusFilter, #dateFromFilter, #dateToFilter').on('change', loadEvents);
    $('#searchFilter').on('keyup', function(e) {
        if (e.key === 'Enter') loadEvents();
    });
}

function showEventForm(mode = 'create', eventId = null) {
    showLoading();
    currentEventId = eventId;

    $.ajax({
        url: '/cscadmin/events/event_form',
        method: 'GET',
        success: function(html) {
            $('#eventModalBody').html(html);
            $('#eventModalTitle').text(mode === 'edit' ? 'Edit Event' : 'Create New Event');
            updateEventSubmitButton(mode);
            if (mode === 'edit' && eventId) {
                loadEventData(eventId);
            } else {
                hideLoading();
            }
            openModal('eventModal');
        },
        error: function() {
            hideLoading();
            showAlert('danger', 'Failed to load event form');
        }
    });
}

function loadEventData(eventId) {
    showLoading();
    $.ajax({
        url: `/cscadmin/events/${eventId}/update/`,
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success && response.event) {
                // Fill basic fields
                $('#eventId').val(response.event.id);
                $('#eventName').val(response.event.name);
                $('#eventDate').val(response.event.date_event);
                $('#eventStartTime').val(response.event.start_at);
                $('#eventEndTime').val(response.event.end_at);
                $('#eventLocation').val(response.event.location);
                $('#eventLandmark').val(response.event.landmark);
                $('#eventPublishStart').val(response.event.start_publish_on);
                $('#eventPublishEnd').val(response.event.end_publish_on);
                $('#eventContext').val(response.event.context);
                $('#eventDescription').val(response.event.description);

                // Checkboxes for labels, types, audiences
                if (Array.isArray(response.event.labels)) {
                    response.event.labels.forEach(function(id) {
                        $(`input[name="eventLabels"][value="${id}"]`).prop('checked', true);
                    });
                }
                if (Array.isArray(response.event.types)) {
                    response.event.types.forEach(function(id) {
                        $(`input[name="eventTypes"][value="${id}"]`).prop('checked', true);
                    });
                }
                if (Array.isArray(response.event.audiences)) {
                    response.event.audiences.forEach(function(id) {
                        $(`input[name="eventAudiences"][value="${id}"]`).prop('checked', true);
                    });
                }

                // Featured image preview
                if (response.event.event_img) {
                    $('#currentImage').attr('src', response.event.event_img);
                    $('#currentImageContainer').removeClass('hidden');
                    $('#fileName').text('Current image');
                } else {
                    $('#currentImageContainer').addClass('hidden');
                    $('#fileName').text('No file chosen');
                }
            }
            hideLoading();
        },
        error: function() {
            hideLoading();
            showAlert('danger', 'Failed to load event data');
        }
    });
}

function updateEventSubmitButton(mode) {
    const $btn = $('#eventModalSubmitBtn');
    if (mode === 'edit') {
        $('#eventSubmitBtnIcon').removeClass('fa-plus-circle').addClass('fa-save');
        $('#eventSubmitBtnText').text('Save Changes');
    } else {
        $('#eventSubmitBtnIcon').removeClass('fa-save').addClass('fa-plus-circle');
        $('#eventSubmitBtnText').text('Add Event');
    }
}

function submitEventForm() {
    showLoading();
    
    const formData = new FormData();
    formData.append('eventName', $('#eventName').val());
    formData.append('eventStatus', $('#eventStatus').val());
    formData.append('eventDate', $('#eventDate').val());
    formData.append('eventStartTime', $('#eventStartTime').val());
    formData.append('eventEndTime', $('#eventEndTime').val());
    formData.append('eventLocation', $('#eventLocation').val());
    formData.append('eventLandmark', $('#eventLandmark').val());
    formData.append('eventPublishStart', $('#eventPublishStart').val());
    formData.append('eventPublishEnd', $('#eventPublishEnd').val());
    formData.append('eventContext', $('#eventContext').val());
    formData.append('eventDescription', $('#eventDescription').val());
    
    // Append checkbox values
    $('input[name="eventLabels"]:checked').each(function() {
        formData.append('eventLabels', $(this).val());
    });
    $('input[name="eventTypes"]:checked').each(function() {
        formData.append('eventTypes', $(this).val());
    });
    $('input[name="eventAudiences"]:checked').each(function() {
        formData.append('eventAudiences', $(this).val());
    });
    
    // Append file if selected
    const fileInput = $('#eventFeaturedImage')[0];
    if (fileInput.files.length > 0) {
        formData.append('eventFeaturedImage', fileInput.files[0]);
    }
    
    // Determine URL based on mode
    const url = currentEventId ? 
        `/cscadmin/events/${currentEventId}/update/` : 
        '/cscadmin/events/create/';
    
    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', response.message || 'Event saved successfully');
                closeModal('eventModal');
                loadEvents();
            } else {
                showAlert('danger', response.error || 'Failed to save event');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to save event';
            showAlert('danger', error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

function renderEventsTable(data) {
    let tableRows = '';
    
    if (data.events && data.events.length > 0) {
        data.events.forEach(event => {
            const statusBadgeClass = {
                'active': 'bg-green-100 text-green-800',
                'expired': 'bg-red-100 text-red-800',
                'scheduled': 'bg-blue-100 text-blue-800'
            }[event.status] || 'bg-gray-100 text-gray-800';
            
            const eventDate = event.date_event ? new Date(event.date_event).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const publishStart = event.start_publish_on ? new Date(event.start_publish_on).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const publishEnd = event.end_publish_on ? new Date(event.end_publish_on).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            }) : 'Not specified';
            
            const eventImage = event.event_img ? 
                `<img src="${event.event_img}" alt="${event.name}" class="h-12 w-12 rounded-md object-cover cursor-pointer hover:opacity-75 event-image-preview" data-src="${event.event_img}">` :
                `<div class="h-12 w-12 rounded-md bg-gray-200 flex items-center justify-center text-gray-400"><i class="fas fa-calendar-alt"></i></div>`;
            
            const context = event.context ? 
                (event.context.length > 100 ? event.context.substring(0, 97) + '...' : event.context) :
                'No description available';
            
            // Group categories
            const labelBadges = (event.labels && event.labels.length) ?
                `<div><span class='text-xs font-semibold text-blue-700'>Label:</span> <span>${event.labels.map(cat => `<span class='px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 mr-1'>${cat}</span>`).join('')}</span></div>` : '';
            const typeBadges = (event.types && event.types.length) ?
                `<div><span class='text-xs font-semibold text-green-700'>Type:</span> <span>${event.types.map(cat => `<span class='px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 mr-1'>${cat}</span>`).join('')}</span></div>` : '';
            const audienceBadges = (event.audiences && event.audiences.length) ?
                `<div><span class='text-xs font-semibold text-purple-700'>Audience:</span> <span>${event.audiences.map(cat => `<span class='px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 mr-1'>${cat}</span>`).join('')}</span></div>` : '';
            const categoriesHtml = (labelBadges || typeBadges || audienceBadges) ?
                `<div class='space-y-1'>${labelBadges}${typeBadges}${audienceBadges}</div>` :
                '<span class="text-gray-400 text-sm">No categories</span>';
            
            // Publish period with labels
            const publishPeriodHtml = `<div><span class='font-semibold text-xs text-gray-600'>Start:</span> <span>${publishStart}</span></div><div><span class='font-semibold text-xs text-gray-600'>End:</span> <span>${publishEnd}</span></div>`;
            
            tableRows += `
                <tr class="${event.is_deleted ? 'bg-gray-50' : 'hover:bg-gray-50'}">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">${eventImage}</div>
                            <div class="ml-4">
                                <div class="text-sm font-medium ${event.is_deleted ? 'text-gray-500' : 'text-gray-900'}">${event.name || 'Untitled Event'}</div>
                                <div class="text-sm ${event.is_deleted ? 'text-gray-400' : 'text-gray-500'} max-w-xl">${context}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm ${event.is_deleted ? 'text-gray-500' : 'text-gray-900'}">${eventDate}</div>
                        <div class="text-sm ${event.is_deleted ? 'text-gray-400' : 'text-gray-500'}">${event.location || 'Not specified'}</div>
                    </td>
                    <td class="px-6 py-4">
                        ${publishPeriodHtml}
                    </td>
                    <td class="px-6 py-4">
                        ${categoriesHtml}
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadgeClass}">
                            ${(event.status || 'unknown').charAt(0).toUpperCase() + (event.status || 'unknown').slice(1)}
                            ${event.is_deleted ? ' (Deleted)' : ''}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right text-sm font-medium">
                        ${event.is_deleted ? `
                            <button class="text-green-600 hover:text-green-900 restore-event-btn mr-3" data-id="${event.id}">
                                <i class="fas fa-trash-restore"></i>
                            </button>
                        ` : `
                            <button class="text-blue-600 hover:text-blue-900 edit-event-btn mr-3" data-id="${event.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-900 delete-event-btn" data-id="${event.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        `}
                    </td>
                </tr>
            `;
        });
    } else {
        tableRows = `
            <tr>
                <td colspan="6" class="px-6 py-12 text-center">
                    <div class="text-gray-400">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i>
                        <p class="text-sm">No events found</p>
                    </div>
                </td>
            </tr>
        `;
    }
    
    $('#eventsTableBody').html(tableRows);
    renderPagination(data);
    
    // Attach event handlers
    $('.edit-event-btn').click(function() {
        const eventId = $(this).data('id');
        showEventForm('edit', eventId);
    });
    
    $('.delete-event-btn').click(function() {
        const eventId = $(this).data('id');
        showDeleteConfirmation(eventId);
    });
    
    $('.restore-event-btn').click(function() {
        const eventId = $(this).data('id');
        restoreEvent(eventId);
    });
    
    $('.event-image-preview').click(function() {
        const imageSrc = $(this).data('src');
        showImagePreview(imageSrc);
    });
}

function renderPagination(data) {
    if (data.total_pages <= 1) {
        $('#paginationContainer').empty();
        return;
    }
    
    let paginationHtml = `
        <nav class="flex items-center justify-between">
            <div class="flex-1 flex justify-between sm:hidden">
                ${data.has_previous ? 
                    `<a href="?page=${data.previous_page_number}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </a>` : 
                    `<span class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">
                        Previous
                    </span>`}
                ${data.has_next ? 
                    `<a href="?page=${data.next_page_number}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </a>` : 
                    `<span class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-300 bg-white cursor-not-allowed">
                        Next
                    </span>`}
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div class="text-sm text-gray-700">
                    Showing <span class="font-medium">${data.start_index}</span> to <span class="font-medium">${data.end_index}</span> of <span class="font-medium">${data.paginator.count}</span> results
                </div>
                <div>
                    <ul class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                        ${data.has_previous ? 
                            `<li>
                                <a href="?page=${data.previous_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Previous</span>
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>` : ''}
                        
                        ${Array.from({length: data.paginator.num_pages}, (_, i) => i + 1).map(page => `
                            <li>
                                ${page === data.number ? 
                                    `<span aria-current="page" class="z-10 bg-blue-50 border-blue-500 text-blue-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                        ${page}
                                    </span>` : 
                                    `<a href="?page=${page}" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                                        ${page}
                                    </a>`}
                            </li>
                        `).join('')}
                        
                        ${data.has_next ? 
                            `<li>
                                <a href="?page=${data.next_page_number}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <span class="sr-only">Next</span>
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>` : ''}
                    </ul>
                </div>
            </div>
        </nav>
    `;
    
    $('#paginationContainer').html(paginationHtml);
}

// Categories management functions
function initializeCategoriesPage() {
    currentCategoryTab = 'labels';
    loadCategoryTab(currentCategoryTab);

    $('[data-tab]').on('click', function(e) {
        e.preventDefault();
        const tab = $(this).data('tab');
        if (tab !== currentCategoryTab) {
            currentCategoryTab = tab;
            loadCategoryTab(tab);
            updateActiveTabStyle(tab);
        }
    });
}

function loadCategoryTab(tab) {
    showLoading();
    
    let url;
    let categoryType;
    
    switch(tab) {
        case 'labels':
            url = "{% url 'manage_labels' %}";
            categoryType = 'label';
            break;
        case 'types':
            url = "{% url 'manage_types' %}";
            categoryType = 'type';
            break;
        case 'audiences':
            url = "{% url 'manage_audiences' %}";
            categoryType = 'audience';
            break;
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
            $('#categories-content').html(response);
            loadData(categoryType);
            updateActiveTabStyle(tab);
        },
        error: function(xhr, status, error) {
            console.error('Error loading category tab:', error);
            showAlert('danger', 'Failed to load category data');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function updateActiveTabStyle(activeTab) {
    $('.categories-tab').removeClass('border-primary-dark text-primary-dark')
                       .addClass('border-transparent text-gray-500');
    $(`.categories-tab[data-tab="${activeTab}"]`).removeClass('border-transparent text-gray-500')
                                               .addClass('border-primary-dark text-primary-dark');
}

function loadData(categoryType) {
    showLoading();
    
    let url;
    switch(categoryType) {
        case 'label':
            url = "{% url 'ajax_labels' %}";
            break;
        case 'type':
            url = "{% url 'ajax_types' %}";
            break;
        case 'audience':
            url = "{% url 'ajax_audiences' %}";
            break;
    }
    
    $.ajax({
        url: url,
        type: 'GET',
        success: function(response) {
            updateTable(categoryType, response.data);
        },
        error: function(xhr, status, error) {
            console.error('Error loading data:', error);
            showAlert('danger', 'Failed to load data');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function updateTable(categoryType, data) {
    let tableBody = '';
    
    if (data.length === 0) {
        tableBody = `
            <tr>
                <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">
                    No items found
                </td>
            </tr>
        `;
    } else {
        data.forEach(item => {
            tableBody += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${escapeHtml(item.type)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">${escapeHtml(item.description) || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${item.is_active ? 
                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Active</span>' : 
                            '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editCategory('${categoryType}', ${item.id}, '${escapeHtml(item.type)}', '${escapeHtml(item.description || '')}', ${item.is_active})" 
                                class="text-blue-600 hover:text-blue-900 mr-3">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeleteCategory('${categoryType}', ${item.id})" 
                                class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                        </td>
                </tr>
            `;
        });
    }
    
    $(`#${categoryType}-table tbody`).html(tableBody);
}

function openAddModal(categoryType) {
    currentCategoryType = categoryType;
    currentCategoryId = '';
    
    let title = '';
    switch(categoryType) {
        case 'label':
            title = 'Add New Event Label';
            break;
        case 'type':
            title = 'Add New Event Type';
            break;
        case 'audience':
            title = 'Add New Target Audience';
            break;
    }
    
    $('#modalTitle').text(title);
    $('#categoryId').val('');
    $('#categoryType').val(categoryType);
    $('#categoryName').val('');
    $('#categoryDescription').val('');
    $('#categoryStatus').val('true');
    
    openModal('categoryModal');
}

function editCategory(categoryType, id, name, description, isActive) {
    currentCategoryType = categoryType;
    currentCategoryId = id;
    
    let title = '';
    switch(categoryType) {
        case 'label':
            title = 'Edit Event Label';
            break;
        case 'type':
            title = 'Edit Event Type';
            break;
        case 'audience':
            title = 'Edit Target Audience';
            break;
    }
    
    $('#modalTitle').text(title);
    $('#categoryId').val(id);
    $('#categoryType').val(categoryType);
    $('#categoryName').val(name);
    $('#categoryDescription').val(description);
    $('#categoryStatus').val(isActive ? 'true' : 'false');
    
    openModal('categoryModal');
}

function saveCategory() {
    showLoading();
    
    const id = $('#categoryId').val();
    const categoryType = $('#categoryType').val();
    const type = $('#categoryName').val();
    const description = $('#categoryDescription').val();
    const is_active = $('#categoryStatus').val() === 'true';
    
    const data = {
        category_type: categoryType,
        type: type,
        description: description,
        is_active: is_active
    };
    
    if (id) {
        data.id = id;
        var url = "{% url 'ajax_update_category' %}";
    } else {
        var url = "{% url 'ajax_create_category' %}";
    }
    
    $.ajax({
        url: url,
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Item saved successfully');
                closeModal('categoryModal');
                loadData(categoryType);
            } else {
                showAlert('danger', response.error || 'Failed to save item');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error saving item:', error);
            showAlert('danger', 'Failed to save item. Please try again.');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function confirmDeleteCategory(categoryType, id) {
    currentCategoryType = categoryType;
    currentCategoryId = id;
    openModal('deleteModal');
}

function confirmDelete() {
    if (itemToDelete.type === 'event') {
        deleteEvent();
    } else if (itemToDelete.type === 'category') {
        deleteCategory();
    } else if (itemToDelete.type === 'account') {
        deleteAccount();
    }
}

function deleteCategory() {
    showLoading();
    
    const data = {
        category_type: currentCategoryType,
        id: currentCategoryId
    };
    
    $.ajax({
        url: "{% url 'ajax_delete_category' %}",
        type: 'POST',
        data: JSON.stringify(data),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Item deleted successfully');
                closeModal('deleteModal');
                loadData(currentCategoryType);
            } else {
                showAlert('danger', response.error || 'Failed to delete item');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error deleting item:', error);
            showAlert('danger', 'Failed to delete item. Please try again.');
        },
        complete: function() {
            hideLoading();
        }
    });
}

function deleteEvent() {
    showLoading();
    
    $.ajax({
        url: `/cscadmin/events/${itemToDelete.id}/delete/`,
        type: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', 'Event deleted successfully');
                closeModal('deleteModal');
                loadEvents();
            } else {
                showAlert('danger', response.error || 'Failed to delete event');
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON?.error || 'Failed to delete event';
            showAlert('danger', error);
        },
        complete: function() {
            hideLoading();
        }
    });
}

// Initialize dashboard on first load
loadPageContent(currentPage);

// Handle navigation
$(document).on('click', '.nav-link[data-page]', function(e) {
    e.preventDefault();
    const page = $(this).data('page');
    loadPageContent(page);
    toggleSidebar(); // Close mobile sidebar if open
});

// Handle pagination clicks
$(document).on('click', '[data-page]', function(e) {
    e.preventDefault();
    const page = $(this).data('page');
    if (page) {
        if (currentPage === 'events') {
            loadEvents(page);
        }
        // Add other page types if needed
    }
});
// Toggle export dropdown
$(document).on('click', '#exportDropdownBtn', function(e) {
    e.stopPropagation();
    $('#exportDropdownMenu').toggleClass('hidden');
});
// Hide dropdown when clicking outside
$(document).on('click', function(e) {
    if (!$(e.target).closest('#exportDropdownBtn').length) {
        $('#exportDropdownMenu').addClass('hidden');
    }
});
// Handle logout
$(document).on('click', 'a[href="{% url "logout" %}"]', function(e) {
    e.preventDefault();
    sessionStorage.removeItem('currentPage');
    window.location.href = $(this).attr('href');
});
    </script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="{% static 'javascript/admin/post_admin.js' %}"></script>
</body>
</html>